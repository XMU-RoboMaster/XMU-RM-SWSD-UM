<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="ASR-Crash" />
      <link rel="shortcut icon" href="../favicon.ico" />
    <title>CAN - 厦门大学·RoboMaster·软件标准化</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "CAN";
        var mkdocs_page_input_path = "CAN-Use.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> 厦门大学·RoboMaster·软件标准化
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Overview</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../Introduction/">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Hardware-Support/">Hardware Support</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Basic</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../TIM-Use/">TIM</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../USART-Use/">USART</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">CAN</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#can-h">can .h</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#cancpp">can.cpp</a>
    </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Controls</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../Software-Install/">Software Install</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Getting-Started/">Getting Started</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Motor-Control/">Motor Control</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">References</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../Motor-Parameters/">Motor Parameters</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">FAQs</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../How-to-Debug/">How to Debug</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">厦门大学·RoboMaster·软件标准化</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Basic &raquo;</li><li>CAN</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>

          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <p>CAN通信是控制电机运动的重要通信方式之一，具体使用方法如下：</p>
<h1 id="canhcancpp">can.h文件与can.cpp的使用</h1>
<h2 id="can-h">can .h</h2>
<pre><code class="language-c++">#pragma once
#include &quot;stm32f4xx_hal.h&quot;
#include &quot;stm32f4xx_hal_can.h&quot;
#include &lt;cstdlib&gt;
#include &lt;cstring&gt;

class CAN
{
    public:
    void Init(CAN_TypeDef* instance);
    void InitFilter();
    HAL_StatusTypeDef Transmit(const uint32_t ID,
                               const uint8_t*const pData,
                               const uint8_t len = 8);
    CAN_HandleTypeDef hcan;
    uint8_t data[8][8];
    private:
    CanTxMsgTypeDef TxMessage;
    CanRxMsgTypeDef RxMessage;
};

extern CAN can1, can2;
</code></pre>
<h2 id="cancpp">can.cpp</h2>
<pre><code class="language-c++">#include &quot;can.h&quot;
#include &quot;PID.h&quot;

void CAN::Init(CAN_TypeDef* instance)
{
    hcan.Instance       = instance;
    hcan.Init.Prescaler = 6;
    hcan.Init.Mode      = CAN_MODE_NORMAL;
    hcan.Init.SJW       = CAN_SJW_1TQ;
    hcan.Init.BS1       = CAN_BS1_2TQ;
    hcan.Init.BS2       = CAN_BS2_4TQ;
    hcan.Init.TTCM      = DISABLE;
    hcan.Init.ABOM      = ENABLE;
    hcan.Init.AWUM      = ENABLE;
    hcan.Init.NART      = DISABLE;
    hcan.Init.RFLM      = DISABLE;
    hcan.Init.TXFP      = DISABLE;
    HAL_CAN_Init(&amp;hcan);
    HAL_CAN_Transmit_IT(&amp;hcan);
    HAL_CAN_Receive_IT(&amp;hcan, CAN_FIFO0);
    InitFilter();
}
void CAN::InitFilter()
{
    //can1 &amp;can2 use same filter config
    CAN_FilterConfTypeDef       CAN_FilterConfigStructure;

    CAN_FilterConfigStructure.FilterNumber         = 0;
    CAN_FilterConfigStructure.FilterMode           = CAN_FILTERMODE_IDMASK;
    CAN_FilterConfigStructure.FilterScale          = CAN_FILTERSCALE_32BIT;
    CAN_FilterConfigStructure.FilterIdHigh         = 0x0000;
    CAN_FilterConfigStructure.FilterIdLow          = 0x0000;
    CAN_FilterConfigStructure.FilterMaskIdHigh     = 0x0000;
    CAN_FilterConfigStructure.FilterMaskIdLow      = 0x0000;
    CAN_FilterConfigStructure.FilterFIFOAssignment = CAN_FilterFIFO0;
    //can1(0-13)和can2(14-27)分别得到一半的filter
    CAN_FilterConfigStructure.BankNumber = 0;
    CAN_FilterConfigStructure.FilterActivation = ENABLE;

    HAL_CAN_ConfigFilter(&amp;hcan, &amp;CAN_FilterConfigStructure);
    //filter config for can2 
    //can1(0-13)和can2(14-27)分别得到一半的filter
    CAN_FilterConfigStructure.FilterNumber = 14;
    HAL_CAN_ConfigFilter(&amp;hcan, &amp;CAN_FilterConfigStructure);

    hcan.pTxMsg = &amp;TxMessage;
    hcan.pRxMsg = &amp;RxMessage;
}

void HAL_CAN_MspInit(CAN_HandleTypeDef* hcan)
{
    GPIO_InitTypeDef GPIO_InitStruct;
    if (hcan-&gt;Instance == CAN1)
    {
        /* Peripheral clock enable */
        __HAL_RCC_CAN1_CLK_ENABLE();
        __HAL_RCC_GPIOA_CLK_ENABLE();
        /**CAN1 GPIO Configuration
            PD0     ------&gt; CAN1_RX
            PD1     ------&gt; CAN1_TX*/
        GPIO_InitStruct.Pin = GPIO_PIN_11 | GPIO_PIN_12;
        GPIO_InitStruct.Mode = GPIO_MODE_AF_PP;
        GPIO_InitStruct.Pull = GPIO_NOPULL;
        GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_VERY_HIGH;
        GPIO_InitStruct.Alternate = GPIO_AF9_CAN1;
        HAL_GPIO_Init(GPIOA, &amp;GPIO_InitStruct);
        /* Peripheral interrupt init */
        HAL_NVIC_SetPriority(CAN1_TX_IRQn, 1, 0);
        HAL_NVIC_EnableIRQ(CAN1_TX_IRQn);
        HAL_NVIC_SetPriority(CAN1_RX0_IRQn, 0, 0);
        HAL_NVIC_EnableIRQ(CAN1_RX0_IRQn);
    }
    else if (hcan-&gt;Instance == CAN2)
    {
        /* Peripheral clock enable */
        __HAL_RCC_CAN2_CLK_ENABLE();
        __HAL_RCC_GPIOB_CLK_ENABLE();
        /**CAN1 GPIO Configuration
            PB12     ------&gt; CAN2_RX
            PB13     ------&gt; CAN2_TX*/
        GPIO_InitStruct.Pin = GPIO_PIN_12 | GPIO_PIN_13;
        GPIO_InitStruct.Mode = GPIO_MODE_AF_PP;
        GPIO_InitStruct.Pull = GPIO_NOPULL;
        GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_VERY_HIGH;
        GPIO_InitStruct.Alternate = GPIO_AF9_CAN2;
        HAL_GPIO_Init(GPIOB, &amp;GPIO_InitStruct);
        /* Peripheral interrupt init */
        HAL_NVIC_SetPriority(CAN2_TX_IRQn, 1, 0);
        HAL_NVIC_EnableIRQ(CAN2_TX_IRQn);
        HAL_NVIC_SetPriority(CAN2_RX0_IRQn, 0, 0);
        HAL_NVIC_EnableIRQ(CAN2_RX0_IRQn);
    }
}

extern &quot;C&quot; void CAN1_TX_IRQHandler()
{
    HAL_CAN_IRQHandler(&amp;can1.hcan);
}
extern &quot;C&quot; void CAN1_RX0_IRQHandler()
{
    HAL_CAN_IRQHandler(&amp;can1.hcan);
}
extern &quot;C&quot; void CAN2_TX_IRQHandler()
{
    HAL_CAN_IRQHandler(&amp;can2.hcan);
}
extern &quot;C&quot; void CAN2_RX0_IRQHandler()
{
    HAL_CAN_IRQHandler(&amp;can2.hcan);
}

HAL_StatusTypeDef CAN::Transmit(const uint32_t ID, const uint8_t*const pData, const uint8_t len)
{
    hcan.pTxMsg-&gt;StdId = ID;
    hcan.pTxMsg-&gt;IDE = CAN_ID_STD;
    hcan.pTxMsg-&gt;RTR = CAN_RTR_DATA;
    hcan.pTxMsg-&gt;DLC = len;
    memcpy(hcan.pTxMsg-&gt;Data, pData, len);
    return HAL_CAN_Transmit(&amp;hcan, 10);
}

void HAL_CAN_RxCpltCallback(CAN_HandleTypeDef* hcan)
{
    if (hcan == &amp;can1.hcan)memcpy(can1.data[hcan-&gt;pRxMsg-&gt;StdId - 0x201], hcan-&gt;pRxMsg-&gt;Data, sizeof(uint8_t) * 8);
    else memcpy(can2.data[hcan-&gt;pRxMsg-&gt;StdId - 0x201], hcan-&gt;pRxMsg-&gt;Data, sizeof(uint8_t) * 8);

    /*#### add enable can it again to solve can receive only one ID problem!!!####**/
    __HAL_CAN_ENABLE_IT(hcan, CAN_IT_FMP0);
}

</code></pre>
<p>​    </p>
<p>将我们的项目文件添加如上两个文件，文件中包括CAN通信的收发方式，可以更方便我们使用CAN通信来进行电机代码的编写</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../USART-Use/" class="btn btn-neutral float-left" title="USART"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../Software-Install/" class="btn btn-neutral float-right" title="Software Install">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright © 2022 ASR-Crash, XMU-RCS</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../USART-Use/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../Software-Install/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
